<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.project.petcarepedia.repository.ReviewMapper">
	<select id="RM_select" parameterType="String" resultType="com.project.petcarepedia.dto.ReviewDto">
		SELECT ROWNUM RNO, RID, T.MID, M.NICKNAME, RCONTENT, TO_CHAR(RDATE, 'YYYY-MM-DD') RDATE, RLIKE, ROUND(RSTAR, 0) RSTAR, RSFILE1, RSFILE2, M.MSFILE
		FROM (SELECT R.RID, R.MID, R.RCONTENT, R.RDATE, R.RLIKE, R.RSTAR, R.RSFILE1, R.RSFILE2 FROM PCP_REVIEW R, PCP_HOSPITAL H
		WHERE R.HID = H.HID AND H.HID=#{hid}
		ORDER BY R.RDATE DESC) T, PCP_MEMBER M 
		WHERE T.MID = M.MID
	</select>
	
	<select id="RM_select2" parameterType="String" resultType="com.project.petcarepedia.dto.ReviewDto">
		SELECT ROWNUM RNO, RID, T.MID, M.NICKNAME, RCONTENT, TO_CHAR(RDATE, 'YYYY-MM-DD') RDATE, RLIKE, ROUND(RSTAR, 0) RSTAR, RSFILE1, RSFILE2, M.MSFILE
		FROM (SELECT R.RID, R.MID, R.RCONTENT, R.RDATE, R.RLIKE, R.RSTAR, R.RSFILE1, R.RSFILE2 FROM PCP_REVIEW R, PCP_HOSPITAL H
		WHERE R.HID = H.HID AND H.HID=#{hid}
		ORDER BY R.RLIKE DESC) T, PCP_MEMBER M 
		WHERE T.MID = M.MID
	</select>
	
	<select id="RM_select3" parameterType="String" resultType="com.project.petcarepedia.dto.ReviewDto">
		SELECT ROWNUM RNO, RID, T.MID, M.NICKNAME, RCONTENT, TO_CHAR(RDATE, 'YYYY-MM-DD') RDATE, RLIKE, ROUND(RSTAR, 0) RSTAR, RSFILE1, RSFILE2, M.MSFILE
		FROM (SELECT R.RID, R.MID, R.RCONTENT, R.RDATE, R.RLIKE, R.RSTAR, R.RSFILE1, R.RSFILE2 FROM PCP_REVIEW R, PCP_HOSPITAL H
		WHERE R.HID = H.HID AND H.HID=#{hid}
		ORDER BY R.RSTAR DESC) T, PCP_MEMBER M 
		WHERE T.MID = M.MID
	</select>
	
	<select id="RM_select4" parameterType="String" resultType="com.project.petcarepedia.dto.ReviewDto">
		SELECT ROWNUM RNO, RID, T.MID, M.NICKNAME, RCONTENT, TO_CHAR(RDATE, 'YYYY-MM-DD') RDATE, RLIKE, ROUND(RSTAR, 0) RSTAR, RSFILE1, RSFILE2, M.MSFILE
		FROM (SELECT R.RID, R.MID, R.RCONTENT, R.RDATE, R.RLIKE, R.RSTAR, R.RSFILE1, R.RSFILE2 FROM PCP_REVIEW R, PCP_HOSPITAL H
		WHERE R.HID = H.HID AND H.HID=#{hid}
		ORDER BY R.RSTAR) T, PCP_MEMBER M 
		WHERE T.MID = M.MID
	</select>
	
	<select id="list" resultType="com.project.petcarepedia.dto.ReviewDto">
		select rownum rno, rid, rcontent, to_char(rdate,'yyyy-mm-dd') rdate, rlike, rstar, mid, hid, hname, animal, gloc, nickname
		from (select r.rid, r.rcontent, r.rdate, r.rlike, r.rstar, r.mid, r.hid, h.hname, h.animal, h.gloc, m.nickname from pcp_review r, pcp_hospital h, pcp_member m
		where r.hid=h.hid and r.mid = m.mid order by r.rdate desc)
	</select>
	
	<select id="listPage" parameterType="com.project.petcarepedia.dto.PageDto" resultType="com.project.petcarepedia.dto.ReviewDto">
		select rno, rid, rcontent, rdate, rlike, rstar, mid, hid, hname, animal, gloc, nickname, msfile
		from (select rownum rno, rid, rcontent, to_char(rdate,'yyyy-mm-dd') rdate, rlike, rstar, mid, hid, hname, animal, gloc, nickname , msfile
		from (select r.rid, r.rcontent, r.rdate, r.rlike, r.rstar, r.mid, r.hid, h.hname, h.animal, h.gloc, m.nickname, m.msfile from pcp_review r, pcp_hospital h, pcp_member m
		where r.hid=h.hid and r.mid = m.mid order by r.rdate desc))
		where rno between #{startCount} and #{endCount}
	</select>
	
	<select id="searchListPage" parameterType="com.project.petcarepedia.dto.PageDto" resultType="com.project.petcarepedia.dto.ReviewDto">
		select rno, rid, rcontent, rdate, rlike, rstar, mid, hid, hname, animal, gloc, nickname, msfile
		from (select rownum rno, rid, rcontent, to_char(rdate,'yyyy-mm-dd') rdate, rlike, rstar, mid, hid, hname, animal, gloc, nickname, msfile
		from (select r.rid, r.rcontent, r.rdate, r.rlike, r.rstar, r.mid, r.hid, h.hname, h.animal, h.gloc, m.nickname, m.msfile from pcp_review r, pcp_hospital h, pcp_member m
		where r.hid=h.hid and r.mid = m.mid order by r.rdate desc) where gloc = #{gloc}) 
		where rno between #{startCount} and #{endCount}
	</select>
	
	<select id="searchCount" parameterType="String" resultType="int">
		select count(*)
		from (select rownum rno, rid, rcontent, to_char(rdate,'yyyy-mm-dd') rdate, rlike, rstar, mid, hid, hname, animal, gloc, nickname
		from (select r.rid, r.rcontent, r.rdate, r.rlike, r.rstar, r.mid, r.hid, h.hname, h.animal, h.gloc, m.nickname from pcp_review r, pcp_hospital h, pcp_member m
		where r.hid=h.hid and r.mid = m.mid order by r.rdate desc) where gloc = #{gloc})
	</select>
	
	<select id="content" parameterType="String" resultType="com.project.petcarepedia.dto.ReviewDto">
		select rownum rno, rid, rcontent, to_char(rdate,'yyyy-mm-dd') rdate, rlike, rstar, mid, hid, rrid, hname, animal, gloc, nickname, rfile1, rsfile1, rfile2, rsfile2, msfile
		from (select r.rid, r.rcontent, r.rdate, r.rlike, r.rstar, r.mid, r.hid, rr.rrid, h.hname, h.animal, h.gloc, m.nickname, r.rfile1, r.rsfile1, r.rfile2, r.rsfile2, m.msfile
			  from pcp_review r, pcp_hospital h, pcp_member m, pcp_review_report rr
		where r.hid=h.hid and r.mid = m.mid and r.rid = rr.rid) where rid = #{rid}
	</select>
	
	<select id="enter_content" parameterType="String" resultType="com.project.petcarepedia.dto.ReviewDto">
		select rownum rno, rid, rcontent, to_char(rdate,'yyyy-mm-dd') rdate, rlike, rstar, mid, hid, hname, animal, gloc, nickname, rfile1, rsfile1, rfile2, rsfile2, msfile
		from (select r.rid, r.rcontent, r.rdate, r.rlike, r.rstar, r.mid, r.hid, h.hname, h.animal, h.gloc, m.nickname, r.rfile1, r.rsfile1, r.rfile2, r.rsfile2, m.msfile
		from pcp_review r, pcp_hospital h, pcp_member m 
		where r.hid=h.hid and r.mid = m.mid) where rid = #{rid}
	</select>
	
	<insert id="insert" parameterType="com.project.petcarepedia.dto.ReviewDto">
		insert into pcp_review(rid, rcontent, rdate, rlike, rstar, mid, hid, bid, rfile1, rsfile1, rfile2, rsfile2 )
		values('R_'||ltrim(to_char(sequ_pcp_review_rid.nextval,'0000')),#{rcontent},sysdate,0,#{rstar},#{mid},#{hid},#{bid},#{rfile1,jdbcType=VARCHAR},#{rsfile1,jdbcType=VARCHAR},
				#{rfile2,jdbcType=VARCHAR},#{rsfile2,jdbcType=VARCHAR})
	</insert>
	
	<update id="update" parameterType="com.project.petcarepedia.dto.ReviewDto">
		update pcp_review set rcontent=#{rcontent}, rstar=#{rstar}, rfile1=#{rfile1,jdbcType=VARCHAR}, rfile2=#{rfile2,jdbcType=VARCHAR}, 
			rsfile1=#{rsfile1,jdbcType=VARCHAR}, rsfile2=#{rsfile2,jdbcType=VARCHAR}  where rid=#{rid}
	</update>
	<select id = "my_content" parameterType="String" resultType="com.project.petcarepedia.dto.ReviewDto">
		SELECT rid, rcontent, rstar, rfile1, rfile2, rsfile1, rsfile2, m.nickname, h.hname from pcp_review r, pcp_member m, pcp_hospital h
		where r.mid = m.mid and r.hid = h.hid and rid = #{rid}
	</select>
	
	<delete id="delete">
		delete pcp_review where rid=#{rid}
	</delete>
	
	<select id="bestList" parameterType="com.project.petcarepedia.dto.PageDto" resultType="com.project.petcarepedia.dto.ReviewDto">
		select rno,rid,hid,rcontent,hname,gloc,rdate,rlike,rstar,mid, nickname 
		from(select rownum rno,rid,hid,rcontent,hname,gloc,rdate,rlike,rstar,mid,nickname
		from(select r.rid,r.hid,r.rcontent,h.hname,h.gloc,to_char(r.rdate,'yyyy-mm-dd') rdate,r.rlike,r.rstar,r.mid,m.nickname
		from pcp_review r, pcp_hospital h, pcp_member m 
		where r.hid=h.hid and r.mid = m.mid  
		order by rlike desc))
		where rno between #{startCount} and #{endCount}
	</select>
	
	<select id="count" resultType="int">
		select count(*) from pcp_review
	</select>

	<!-- pageMapper 추가  -->
	<select id = "Mylist" parameterType = "com.project.petcarepedia.dto.PageDto" resultType = "com.project.petcarepedia.dto.ReviewDto">
		select rno, hid, hname, nickname, tel, gloc, rcontent, rid, bid, hsfile1, rfile1, rsfile1, rfile2, rsfile2, msfile
		from (select rownum rno, hid, hname, nickname, tel, gloc, rcontent, rid, bid, hsfile1, rfile1, rsfile1, rfile2, rsfile2, msfile
			  from (select h.hid, h.hname, m.nickname, h.tel, h.gloc, r.rcontent, rid, r.bid, h.hsfile1, r.rfile1, r.rsfile1, r.rfile2, r.rsfile2, m.msfile  from pcp_review r, pcp_member m, pcp_hospital h, pcp_booking b
					where r.mid = m.mid and h.hid = r.hid and b.bid = r.bid and r.mid = #{mid} order by r.rid desc))
		where rno between #{startCount} AND #{endCount}

	</select>

	<select id="MRlist" parameterType="com.project.petcarepedia.dto.PageDto" resultType="com.project.petcarepedia.dto.ReviewDto">
		SELECT * FROM
			(SELECT ROWNUM RNO, RID, HID, MID, BID, RCONTENT, TO_CHAR(RDATE, 'YYYY-MM-DD') RDATE, RLIKE, RSTAR, RFILE1, RSFILE1, RFILE2, RSFILE2
			 FROM (SELECT * FROM PCP_REVIEW WHERE HID=#{hid} ORDER BY RDATE DESC))
		WHERE RNO between #{startCount} AND #{endCount}
	</select>

	<select id="MRRlist" parameterType="com.project.petcarepedia.dto.PageDto" resultType="com.project.petcarepedia.dto.ReviewDto">
		SELECT RNO, RID, MID, HID, RCONTENT, RDATE
		FROM (SELECT ROW_NUMBER() OVER(ORDER BY R.RID DESC) AS RNO, R.RID, R.MID, R.HID, R.RCONTENT, TO_CHAR(R.RDATE, 'YYYY-MM-DD') RDATE
			  FROM PCP_REVIEW_REPORT RR
					   JOIN PCP_REVIEW R ON R.RID = RR.RID
			  WHERE RR.HID=#{hid}
			  GROUP BY R.RID, R.MID, R.HID, R.RCONTENT, TO_CHAR(R.RDATE, 'YYYY-MM-DD')
			  ORDER BY R.RID DESC) R
		WHERE RNO BETWEEN #{startCount} AND #{endCount}
	</select>

	<!--예약상세 - 리뷰보기-->
	<select id="bookingReveiw" parameterType="String" resultType="com.project.petcarepedia.dto.ReviewDto">
		SELECT ROWNUM RNO, BID, RID, RCONTENT, RDATE, RLIKE, RSTAR, RSTATE, MID, HID, HNAME, NICKNAME, RFILE1, RSFILE1, RFILE2,RSFILE2, MSFILE
		FROM(SELECT R.BID, R.RID, R.RCONTENT, TO_CHAR(R.RDATE, 'YYYY-MM-DD') RDATE, R.RLIKE, R.RSTAR, R.RSTATE, R.MID, R.HID, H.HNAME, M.NICKNAME, R.RFILE1, R.RSFILE1, R.RFILE2, R.RSFILE2, M.MSFILE
			 FROM PCP_REVIEW R, PCP_HOSPITAL H, PCP_MEMBER M
			 WHERE R.HID = H.HID AND R.MID = M.MID)
		WHERE BID = #{bid}
	</select>

	<select id="bookingReveiwCount" parameterType="String" resultType="int">
		SELECT COUNT(*) FROM PCP_REVIEW WHERE BID = #{bid}
	</select>

</mapper>