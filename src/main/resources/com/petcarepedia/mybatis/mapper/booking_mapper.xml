<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.project.petcarepedia.repository.BookingMapper">

	<insert id="insert" parameterType="com.project.petcarepedia.dto.BookingDto">
		INSERT INTO PCP_BOOKING(bid, bdate, vdate, vtime, bstate, mid, hid)
		values ('B_'||LTRIM(to_char(SEQU_PCP_BOOKING_BID.nextVal, '0000')), sysdate, #{vdate}, #{vtime}, '예약중', #{mid}, #{hid})
	</insert>

	<select id="checkBooking" parameterType="com.project.petcarepedia.dto.BookingDto" resultType="int">
		SELECT COUNT(*)
		FROM PCP_BOOKING
		WHERE MID=#{mid} AND HID=#{hid} AND VDATE=#{vdate} AND VTIME=#{vtime}
	</select>

	<select id="select" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT ROWNUM RNO, BID, TO_CHAR(BDATE, 'YYYY-MM-DD') BDATE, VDATE, VTIME, BSTATE, MID, HNAME
		FROM (SELECT B.BID, B.BDATE, B.VDATE, B.VTIME, B.BSTATE, B.MID, H.HNAME
			  FROM PCP_BOOKING B, PCP_HOSPITAL H
			  WHERE B.HID = H.HID
			  ORDER BY B.BID DESC);
	</select>

	<select id="select2" parameterType="String" resultType="com.project.petcarepedia.dto.BookingDto">
		select BID, VDATE, VTIME, B.MID, B.HID, H.HNAME, H.TEL, H.IMG
		FROM PCP_BOOKING B, PCP_HOSPITAL H
		WHERE B.HID = H.HID AND B.bid = #{bid}
	</select>

	<select id="search" parameterType="String" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT B.BID, B.BDATE, B.VDATE, B.VTIME, B.BSTATE, B.MID, B.HID, H.HNAME, H.LOC, H.GLOC, H.TEL
		FROM PCP_BOOKING B, PCP_HOSPITAL H
		WHERE B.HID = H.HID
		  AND B.MID =#{mid}
	</select>

	<select id="search1" parameterType="String" resultType="com.project.petcarepedia.dto.BookingDto">
		select bid, bdate, vdate, vtime, bstate, mid, hid, hname, loc, gloc, tel, hrink, img, HSFILE1, HSFILE
		from(select b.bid bid, b.bdate bdate, b.vdate vdate, b.vtime vtime, b.bstate bstate, b.mid mid, b.hid hid, h.hname hname,H.HSFILE1 HSFILE1,H.HSFILE HSFILE,
					h.loc loc, h.gloc gloc, h.tel tel, h.hrink hrink, h.img img
			 from pcp_review r, pcp_booking b, pcp_hospital h, pcp_member m
			 where r.bid(+) = b.bid
			   and b.hid = h.hid and b.mid = m.mid and b.mid = #{mid} and  r.bid is null)
		where to_char(sysdate,'yyyy-mm-dd') > vdate or (vdate = to_char(sysdate,'yyyy-mm-dd')
			and to_char(sysdate,'hh24:mi') > vtime) order by bid desc
	</select>

	<select id="search2" parameterType="String" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT BID, BDATE, VDATE, VTIME, BSTATE, MID, HID, HNAME, LOC, GLOC, TEL,HRINK, IMG, HSFILE1, HSFILE
		FROM (SELECT BID, BDATE, VDATE, VTIME, BSTATE, B.MID MID, B.HID HID, H.HNAME HNAME, H.LOC LOC, H.GLOC GLOC, H.TEL TEL, H.HRINK HRINK,
		             H.IMG IMG, H.HSFILE1 HSFILE1, H.HSFILE HSFILE
			  FROM PCP_BOOKING B, PCP_HOSPITAL H
			  WHERE B.HID = H.HID AND B.MID = #{mid} AND VDATE = TO_CHAR(SYSDATE,'YYYY-MM-DD'))
		WHERE VTIME >= TO_CHAR(SYSDATE,'HH24:MI') order by bid desc
	</select>

	<select id="search3" parameterType="String" resultType="com.project.petcarepedia.dto.BookingReviewDto">
		select bid, bdate, vdate, vtime, bstate, mid, hid, hname, loc, gloc, tel, hrink, img, rid, HSFILE1, HSFILE
		from(select b.bid bid, b.bdate bdate, b.vdate vdate, b.vtime vtime, b.bstate bstate, b.mid mid, b.hid hid, h.hname hname,H.HSFILE1 HSFILE1, H.HSFILE HSFILE,
					h.loc loc, h.gloc gloc, h.tel tel, h.hrink hrink, h.img img, r.rid rid
			 from pcp_review r, pcp_booking b, pcp_hospital h, pcp_member m
			 where b.hid = h.hid and b.mid = m.mid and b.mid = #{mid} and b.bid = r.bid)
		order by bid desc
	</select>

	<select id="search4" parameterType="String" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT BID, BDATE, VDATE, VTIME, BSTATE, MID, HID, HNAME, LOC, GLOC, TEL,HRINK, IMG, HSFILE1, HSFILE
		FROM (SELECT BID, BDATE, VDATE, VTIME, BSTATE, B.MID MID, B.HID HID, H.HNAME HNAME, H.LOC LOC, H.GLOC GLOC,
		             H.TEL TEL, H.HRINK HRINK, H.IMG IMG, H.HSFILE1 HSFILE1, H.HSFILE HSFILE
			  FROM PCP_BOOKING B, PCP_HOSPITAL H
			  WHERE B.HID = H.HID AND B.MID = #{mid} AND VDATE > TO_CHAR(SYSDATE,'YYYY-MM-DD')) order by bid desc
	</select>

	<select id="search5" parameterType="String" resultType="com.project.petcarepedia.dto.BookingDto">
		select bid, hname, b.mid mid, to_char(BDATE, 'yyyy-mm-dd') VDATE, bstate
		from  pcp_booking b, pcp_hospital h
		where b.hid = h.hid and b.mid like '%'|| #{mid} ||'%'
	</select>

	<select id="reviewCheck" parameterType="map" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT COUNT(*) COUNT, MID, BID, HID
		FROM PCP_BOOKING WHERE HID=#{hid} AND MID=#{mid}
		GROUP BY MID, BID, HID
	</select>

	<select id="selectTime" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT HID, HNAME, SUBSTR(HTIME, 0, 5) AS "START", SUBSTR(HTIME, 7, 6) AS "END"
		FROM PCP_HOSPITAL ORDER BY HID
	</select>

	<select id="selectTime2" parameterType="String" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT HID, HNAME, SUBSTR(HTIME, 1, 5) AS "START", SUBSTR(HTIME, 7, 6) AS "END"
		FROM PCP_HOSPITAL
		WHERE HID=#{hid}
	</select>

	<!--page_mapper-->
	<select id = "Bslist" parameterType="com.project.petcarepedia.dto.PageDto" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT RNO, HNAME, MID, VDATE, BSTATE, VTIME, BID, BDATE
		FROM (
				 SELECT ROWNUM RNO, HNAME, MID, to_char(BDATE, 'yyyy-mm-dd') VDATE, BSTATE, VTIME, BID, BDATE
				 FROM (
						  SELECT H.HNAME, M.MID, VDATE, B.BSTATE, VTIME, BID, BDATE
						  FROM PCP_BOOKING B
								   JOIN PCP_HOSPITAL H ON B.HID = H.HID
								   JOIN PCP_MEMBER M ON M.MID = B.MID
						  WHERE M.MID LIKE '%' || #{mid} || '%'
						  ORDER BY BDATE DESC
					  )
			 )
		WHERE RNO BETWEEN #{startCount} AND #{endCount}
	</select>

	<select id = "Blist" parameterType="com.project.petcarepedia.dto.PageDto" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT RNO, HNAME, MID, VDATE,  BSTATE, VTIME, BID, BDATE
		FROM (SELECT ROWNUM RNO, HNAME,  MID,   to_char(BDATE, 'yyyy-mm-dd') VDATE ,BSTATE, VTIME,  BID, BDATE
			  FROM (SELECT H.HNAME, M.MID ,  VDATE ,B.BSTATE,VTIME , BID, BDATE
					FROM PCP_BOOKING B, PCP_HOSPITAL H,  PCP_MEMBER M where b.hid = h.hid AND M.MID = B.MID ORDER BY BDATE DESC))
		WHERE RNO BETWEEN #{startCount} AND #{endCount}
	</select>
	<!--page_mapper-->

	<update id="update" parameterType="com.project.petcarepedia.dto.BookingDto">
		UPDATE PCP_BOOKING SET VDATE=#{vdate}, VTIME=#{vtime}, BSTATE=#{bstate} WHERE BID=#{bid}
	</update>

	<delete id="delete" parameterType="String">
		DELETE FROM PCP_BOOKING WHERE BID=#{bid}
	</delete>

	<update id="Bselect" parameterType="String">
		update pcp_booking set bstate = '예약 완료' where bid=#{bid}
	</update>

	<!--7/26-->
	<select id="HBlist" parameterType="com.project.petcarepedia.dto.PageDto" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT RNO, BID, BDATE, BSTATE, VDATE, VTIME, HID, HNAME, MID, NAME, PHONE
		FROM (SELECT ROWNUM RNO, BID, BDATE, BSTATE, VDATE, VTIME, HID, HNAME, MID, NAME, PHONE
			  FROM (SELECT B.BID, B.BDATE, B.BSTATE, B.VDATE, B.VTIME, H.HID, H.HNAME, M.MID, M.NAME, M.PHONE
					FROM PCP_BOOKING B, PCP_HOSPITAL H, PCP_MEMBER M WHERE B.HID=H.HID AND M.MID = B.MID ORDER BY VDATE DESC, VTIME DESC)
			  WHERE HID=#{hid})
		WHERE RNO BETWEEN #{startCount} AND #{endCount}
	</select>

	<!--예약상태 필터-->
	<select id="HBlist2" parameterType="com.project.petcarepedia.dto.PageDto" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT RNO, BID, BDATE, BSTATE, VDATE, VTIME, HID, MID, NAME, PHONE
		FROM (SELECT ROWNUM RNO, BID, BDATE, BSTATE, VDATE, VTIME, HID, MID, NAME, PHONE
			  FROM (SELECT B.BID, B.BDATE, B.BSTATE, B.VDATE, B.VTIME, B.HID, M.MID, M.NAME, M.PHONE
					FROM PCP_BOOKING B, PCP_MEMBER M WHERE M.MID = B.MID AND B.HID=#{hid}
					ORDER BY BDATE DESC)
			  WHERE BSTATE='예약중')
		WHERE RNO BETWEEN #{startCount} AND #{endCount}
	</select>


	<select id="HBlist3" parameterType="com.project.petcarepedia.dto.PageDto" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT RNO, BID, BDATE, BSTATE, VDATE, VTIME, HID, MID, NAME, PHONE
		FROM (SELECT ROWNUM RNO, BID, BDATE, BSTATE, VDATE, VTIME, HID, MID, NAME, PHONE
			  FROM (SELECT B.BID, B.BDATE, B.BSTATE, B.VDATE, B.VTIME, B.HID, M.MID, M.NAME, M.PHONE
					FROM PCP_BOOKING B, PCP_MEMBER M WHERE M.MID = B.MID AND B.HID=#{hid}
					ORDER BY BDATE DESC)
			  WHERE BSTATE='예약취소')
		WHERE RNO BETWEEN #{startCount} AND #{endCount}
	</select>


	<select id="HBlist4" parameterType="com.project.petcarepedia.dto.PageDto" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT RNO, BID, BDATE, BSTATE, VDATE, VTIME, HID, MID, NAME, PHONE
		FROM (SELECT ROWNUM RNO, BID, BDATE, BSTATE, VDATE, VTIME, HID, MID, NAME, PHONE
			  FROM (SELECT B.BID, B.BDATE, B.BSTATE, B.VDATE, B.VTIME, B.HID, M.MID, M.NAME, M.PHONE
					FROM PCP_BOOKING B, PCP_MEMBER M WHERE M.MID = B.MID AND B.HID=#{hid}
					ORDER BY BDATE DESC)
			  WHERE BSTATE='진료완료')
		WHERE RNO BETWEEN #{startCount} AND #{endCount}
	</select>

	<select id="HBslist" parameterType="com.project.petcarepedia.dto.PageDto" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT RNO, VDATE, BSTATE, VTIME, BID, BDATE, HID, HNAME, MID, NAME, PHONE
		FROM (SELECT ROWNUM RNO, VDATE, BSTATE, VTIME, BID, BDATE, HID, HNAME, MID, NAME, PHONE
			  FROM (SELECT VDATE, BSTATE, VTIME, BID, BDATE, HID, HNAME, MID, NAME, PHONE
					FROM (SELECT to_char(TO_DATE(VDATE), 'yyyy-mm-dd') VDATE, B.BSTATE, B.VTIME, B.BID, B.BDATE, H.HID, H.HNAME, M.MID, M.NAME, M.PHONE
						  FROM PCP_BOOKING B, PCP_HOSPITAL H, PCP_MEMBER M where b.hid = h.hid AND M.MID = B.MID AND H.HID=#{hid}
						  ORDER BY BDATE DESC)
					WHERE MID LIKE '%' || #{mid} || '%'))
		WHERE RNO BETWEEN #{startCount} AND #{endCount}
	</select>


	<!--예약검색-->
	<select id="nowBooking" parameterType="String" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT BID, MID, HID, TO_CHAR(BDATE, 'YYYY.MM.DD.HH24:MI:SS') AS BDATE, TO_CHAR(TO_DATE(VDATE), 'YYYY.MM.DD.') AS VDATE, VTIME, BSTATE
		FROM PCP_BOOKING WHERE BID=#{bid}
	</select>

	<select id="bookingList" parameterType="com.project.petcarepedia.dto.PageDto" resultType="com.project.petcarepedia.dto.BookingDto">
		SELECT RNO, BID, BDATE, BSTATE, VDATE, VTIME, HID, MID, NAME, PHONE
		FROM (SELECT ROWNUM RNO, BID, BDATE, BSTATE, VDATE, VTIME, HID, MID, NAME, PHONE
			  FROM (SELECT B.BID, B.BDATE, B.BSTATE, B.VDATE, B.VTIME, B.HID, M.MID, M.NAME, M.PHONE
					FROM PCP_BOOKING B, PCP_MEMBER M WHERE M.MID = B.MID AND M.MID=#{mid} AND B.HID=#{hid}
					ORDER BY VDATE DESC, VTIME DESC))
		WHERE RNO BETWEEN #{startCount} AND #{endCount}
	</select>

	<!--예약취소-->
	<update id="cancel" parameterType="String">
		update PCP_BOOKING SET BSTATE='예약취소' WHERE BID=#{bid}
	</update>

	<!--예약상태 업데이트-->
	<update id="bookingUpdate">
		UPDATE PCP_BOOKING SET BSTATE='진료완료'
		WHERE SYSDATE > TO_DATE(VDATE || ' ' || VTIME, 'YYYY-MM-DD HH24:MI:SS') AND BSTATE='예약중'
	</update>

	<!--관리자 - 예약 상세 페이지 추가-->
	<select id="content" parameterType="String" resultType="com.project.petcarepedia.dto.BookingDto">
		select bid, b.mid, h.hid, h.hname, bdate, bstate, vdate, vtime from pcp_booking b, pcp_hospital h where h.hid = b.hid and bid=#{bid}
	</select>

</mapper>
